<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">


    <changeSet id="20251114-01" author="vsinkievic">
        <loadData
                  file="config/liquibase/data/cupa_authority.csv"
                  separator=";"
                  tableName="jhi_authority"
                  usePreparedStatements="true">
            <column name="name" type="string"/>
        </loadData>
        <loadData
                  file="config/liquibase/data/cupa_user.csv"
                  separator=";"
                  tableName="jhi_user"
                  usePreparedStatements="true">
            <column name="id" type="numeric"/>
            <column name="activated" type="boolean"/>
            <column name="created_at" type="timestamp with time zone"/>
        </loadData>
        <loadData
                  file="config/liquibase/data/cupa_user_authority.csv"
                  separator=";"
                  tableName="jhi_user_authority"
                  usePreparedStatements="true">
            <column name="user_id" type="numeric"/>
        </loadData>
    </changeSet>

    <changeSet id="20251114-02" author="vsinkievic">
        <sql>
            UPDATE jhi_user SET dtype = 'CUPA_USER' WHERE dtype = 'VAPP_USER';
        </sql>
    </changeSet>


    <changeSet id="20251118-01" author="vsinkievic">
        <preConditions onFail="MARK_RAN">
            <dbms type="postgresql"/>
        </preConditions>
        
        <comment>
            Migrate text columns that incorrectly stored OIDs (Large Object pointers) 
            instead of actual text data due to Hibernate @Lob mapping.
        </comment>

        <sql>
            -- Fix request_data
            UPDATE public.payment_transaction
            SET request_data = convert_from(lo_get(request_data::oid), 'UTF8')
            WHERE request_data ~ '^[0-9]+$';

            -- Fix initial_response_data
            UPDATE public.payment_transaction
            SET initial_response_data = convert_from(lo_get(initial_response_data::oid), 'UTF8')
            WHERE initial_response_data ~ '^[0-9]+$';

            -- Fix callback_data
            UPDATE public.payment_transaction
            SET callback_data = convert_from(lo_get(callback_data::oid), 'UTF8')
            WHERE callback_data ~ '^[0-9]+$';

            -- Fix last_query_data
            UPDATE public.payment_transaction
            SET last_query_data = convert_from(lo_get(last_query_data::oid), 'UTF8')
            WHERE last_query_data ~ '^[0-9]+$';
        </sql>

        <sql>
            -- Fix request_data
            UPDATE public.audit_log
            SET request_data = convert_from(lo_get(request_data::oid), 'UTF8')
            WHERE request_data ~ '^[0-9]+$';

            -- Fix response_data
            UPDATE public.audit_log
            SET response_data = convert_from(lo_get(response_data::oid), 'UTF8')
            WHERE response_data ~ '^[0-9]+$';
        </sql>
        
    </changeSet>

</databaseChangeLog>